bundle:
  name: cdp_core
  uuid: 98c7c9ce-c84d-4717-b5d8-25950e338d17

include:
  - resources/*.yml
  - resources/*/*.yml

variables:
  environment:
    description: "Environment to deploy the bundle to"
    default: ''
  whl_path: 
    description: "Path to the wheel file in the Databricks workspace"
    default: ''
  SPN_ID:
    description: "Service Principal ID for the Databricks workspace"
    default: ''
  policy_id:
    description: "Compute policy"
    default: ''
  data_engineering_group:
    description: "Group"
    default: ""
  # host:
  #   description: "Databricks host defaults to the DEV one"
  #   default: https://adb-6686411646094.14.azuredatabricks.net/

artifacts:
  default:
    type: whl
    build: python setup.py bdist_wheel --dist-dir packages/
    files: 
      - source: packages/*.whl

targets:
  # this deployment allows individual users to deploy within an isolated user's path
  user:
    mode: development
    default: true
    workspace:
      root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}
      host: https://adb-1036309900456578.18.azuredatabricks.net/
    presets:
      name_prefix: "[${workspace.current_user.short_name}][${bundle.git.branch}]"
      pipelines_development: true
      trigger_pause_status: PAUSED
      jobs_max_concurrent_runs: 10
  
  # below main environments are only executed during CICD runs via the environment's service principal
  development:
    mode: production
    workspace:
      root_path: /Workspace/Users/${var.SPN_ID}/.bundle/${bundle.name}
      host: https://adb-1036309900456578.18.azuredatabricks.net/
    permissions:
      - group_name: ${var.data_engineering_group}
        level: "CAN_RUN"
      - service_principal_name: ${var.SPN_ID}
        level: "CAN_MANAGE"
    run_as:
      service_principal_name: ${var.SPN_ID}
    presets:
      name_prefix: "[main]"
      # name_prefix: "[${bundle.git.branch}]"
      pipelines_development: true
      trigger_pause_status: PAUSED
      jobs_max_concurrent_runs: 10
  
  test:
    mode: production
    workspace:
      root_path: /Workspace/Users/${var.SPN_ID}/.bundle/${bundle.name}
      host: https://adb-6686411646094.14.azuredatabricks.net/
    run_as:
      service_principal_name: ${var.SPN_ID}
    permissions:
      - group_name: ${var.data_engineering_group}
        level: "CAN_RUN"
      - service_principal_name: ${var.SPN_ID}
        level: "CAN_MANAGE"
    presets:
      name_prefix: "[main]"
      # name_prefix: "[${bundle.git.branch}]"
      pipelines_development: true
      trigger_pause_status: PAUSED
      jobs_max_concurrent_runs: 10
