bundle:
  name: cdp_core
  uuid: 98c7c9ce-c84d-4717-b5d8-25950e338d17

include:
  - resources/*.yml
  - resources/*/*.yml

variables:
  whl_path: 
    description: "Path to the wheel file in the Databricks workspace"
    default: ''
  spn_id:
    description: "Service Principal ID for the Databricks workspace"
    default: ''
  policy_id:
    description: "Compute policy"
    default: '00083BE3CC143C48'
  data_engineering_group:
    description: "Group"
    default: ""
  environment:
    description: "primarily used to determine the OS env variable when starting a job cluster"
    default: "dev" 
  warehouse_id:
    description: "warehouse id used for permissions"
    default: 907711fee55bc4b6
  catalog:
    description: "Unity Catalog for Permissions Script"
    default: "`catalog-dev-uks-corecdp-001`"

artifacts:
  default:
    type: whl
    path: ../..
    build: python -m build --wheel --dist-dir packages/

targets:
  # this deployment allows individual users to deploy within an isolated user's path
  user:
    mode: development
    default: true
    workspace:
      root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}
      host: https://adb-1036309900456578.18.azuredatabricks.net/
    presets:
      name_prefix: "[${workspace.current_user.short_name}][${bundle.git.branch}]"
      pipelines_development: true
      trigger_pause_status: PAUSED
      jobs_max_concurrent_runs: 10
    variables: 
      spn_id: "${workspace.current_user.userName}"
  
  # below main environments are only executed during CICD runs via the environment's service principal
  dev:
    mode: production
    workspace:
      root_path: /Workspace/Users/${var.spn_id}/.bundle/${bundle.name}
      host: https://adb-1036309900456578.18.azuredatabricks.net/
    permissions:
      - group_name: ${var.data_engineering_group}
        level: "CAN_RUN"
      - service_principal_name: ${var.spn_id}
        level: "CAN_MANAGE"
    run_as:
      service_principal_name: ${var.spn_id}
    presets:
      name_prefix: "[main]"
      pipelines_development: true
      trigger_pause_status: PAUSED
      jobs_max_concurrent_runs: 10

  tst:
    mode: production
    workspace:
      root_path: /Workspace/Users/${var.spn_id}/.bundle/${bundle.name}
      host: https://adb-6686411646094.14.azuredatabricks.net/
    run_as:
      service_principal_name: ${var.spn_id}
    permissions:
      - group_name: ${var.data_engineering_group}
        level: "CAN_RUN"
      - service_principal_name: ${var.spn_id}
        level: "CAN_MANAGE"
    presets:
      name_prefix: "[main]"
      pipelines_development: true
      trigger_pause_status: PAUSED
      jobs_max_concurrent_runs: 10
    variables: 
      environment: "tst"
      catalog: "`catalog-tst-uks-corecdp-001`"
