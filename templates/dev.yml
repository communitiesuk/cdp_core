parameters:
  - name: environment
    type: string

stages:
  - stage: DEV
    displayName: "DEV"
    jobs:
      - job: DEV
        displayName: "Deploy DEV"
        variables:
          - template: variables.yml
            parameters:
              environment: ${{ parameters.environment }}

        steps:
          # 1. Install All Requirements & Allowing Executables
          - script: |
              # Install the Databricks CLI and other requirements
              curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
              pip install pylint yamllint
              
              # Allow the bump-version script to be executable
              chmod +x ./templates/scripts/bump-version.sh
            displayName: "Install Agent Requirements & Allowing Executables"
          
          # 2. Get and Increment Tag
          - script: templates/scripts/bump-version.sh
            name: setTag
            displayName: "Get and Increment Tag"

          # 3. Set Environment Variables
          - script: |
              set -e
              # variable dependent from the previous step             
              export WHL_FILE=cdp_core-$(setTag.BUILD_VERSION)-py3-none-any.whl
              export SOURCE_PATH=packages/$(WHL_FILE)
              export TARGET_PATH=/Workspace/Shared/artifacts/$(WHL_FILE)
              export BUNDLE_VAR="environment=$(ENVIRONMENT),whl_path=/Workspace/Shared/artifacts/$(WHL_FILE),SPN_ID=$(SPN_ID)"
              echo $BUNDLE_VAR
            displayName: "Setting Environment Variables"

          # - script: |
          #     export SOURCE_PATH=packages/$(WHL_FILE)
          #     export TARGET_PATH=/Workspace/Shared/artifacts/$(WHL_FILE)
          #     export BUNDLE_VAR="environment=$(ENVIRONMENT),whl_path=/Workspace/Shared/artifacts/$(WHL_FILE),SPN_ID=$(SPN_ID)"
          #     echo $BUNDLE_VAR
          #   displayName: "Setting Source & Target Paths and Bundle Vars "

          # 4. Run PyLint
          - script: |
              pylint src/ --rcfile=.pylintrc --exit-zero
            displayName: "Run PyLint"
          
          # 5. Run YamlLint
          - script: |
              yamllint -c .yamllint . || true
            displayName: "Run YamlLint"

          # 6. Validate Databricks Bundle
          - template: steps/dev_azure_cli.yml
            parameters:
              description: "Validating Databricks Bundle"
              inlineScript: |
                databricks bundle validate --var=$(BUNDLE_VAR)

          # 7. Deploy Databricks Bundle
          - template: steps/dev_azure_cli.yml
            parameters:
              description: "Deploy Databricks Bundle"
              inlineScript: |
                databricks bundle deploy --var=$(BUNDLE_VAR)
          
          # # 8. Run Unit Tests
          # - template: steps/dev_azure_cli.yml
          #   parameters:
          #     description: "Unit Tests"
          #     inlineScript: |
          #       databricks bundle run jb_pytest --var="environment=$(BUNDLE_VAR)
          
          # 9. Copy whl file to gold volume
          - template: steps/dev_azure_cli.yml
            parameters:
              description: "Copying whl file to Shared Area"
              inlineScript: |


                databricks workspace mkdirs /Shared/artifacts
                databricks workspace import --overwrite --format "AUTO" --file $(SOURCE_PATH) $(TARGET_PATH)
                