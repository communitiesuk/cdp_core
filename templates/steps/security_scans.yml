parameters:
  - name: scanType
    type: string
  - name: inlineScript
    type: string
  - name: severity
    type: string
    default: ''

steps:
  - script: |
      # activate environment - new step starts a new shell session, so previous activation is no longer active
      source venv/bin/activate

      # 
      fullCommand="${{ parameters.inlineScript }}"

      if [ "${{ parameters.scanType}}" = "bandit" ]; then
        fullCommand="${{ parameters.inlineScript }} --exit-zero"
      fi

      eval $fullCommand
    displayName: "Run ${{ parameters.scanType }}"

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: 'security_reports'
      artifactName: 'security-reports'
      publishLocation: 'Container'
    displayName: "Publish ${{ parameters.scanType }} Scan Report"

  - script: |
      source venv/bin/activate
      fullCommand="${{ parameters.inlineScript }} --severity-level ${{ parameters.severity }}"

      if [ "${{ parameters.scanType}}" = "pip-audit" ]; then
        # temp remove the --strict flag as cdp-core is not part of PYPI
        fullCommand="${{ parameters.inlineScript }}"
      fi

      eval $fullCommand  
    displayName: "Run ${{ parameters.scanType }} - Fail on Severity Level"
