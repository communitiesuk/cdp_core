trigger:
  branches:
    include:
      - main

pr:
  branches:
    exclude:
      - "*"

parameters:
  - name: releaseNotes
    displayName: 'Release Notes'
    type: string
    default: 'Release notes for the production deployment.'
  - name: notifyUsers
    displayName: 'Notify Users - one email per line'
    type: object
    default: []

variables:
  - group: cdp-core-pipeline-global-vars 

stages:
  ############################## DEV Stage #########################################
  - template: templates/dev.yml
    parameters:
      environment: 'development'

  ############################## TEST Stage ########################################
  - template: templates/test.yml
    parameters:
      environment: 'test'

  ############################## MANUAL Approval Stage #############################
  - stage: ProdApproval
    condition: succeeded('TEST')
    displayName: "APPROVAL GATE"
    jobs:
      - template: templates/modules/jobs/approval_gate.yml
        parameters:
          notifyUsers: ${{ parameters.notifyUsers }}

  ############################## PROD Stage ########################################
  - template: templates/prod.yml
    parameters:
      environment: 'production'
  
  ############################## RELEASE Stage #####################################
  - stage: TagAndRelease
    displayName: "TAG & RELEASE"
    condition: succeeded('PROD') 
    jobs:
      - template: templates/modules/jobs/tag_and_release.yml
