trigger:
  branches:
    include:
      - main

parameters:
  - name: releaseNotes
    type: string
    default: 'Release notes for the production deployment.'

variables:
  - group: cdp-core-pipeline-global-vars 

stages:
  ############################## DEV Stage #########################################
  # - template: templates/dev.yml
  #   parameters:
  #     environment: 'development'

  ############################## TEST Stage #########################################
  # - template: templates/test.yml
  #   parameters:
  #     environment: 'test'

  ############################## MANUAL Approval Stage ##############################
  # - stage: ProdApproval
  #   dependsOn: TEST
  #   condition: succeeded('TEST')
  #   displayName: "Prod Approval"
  #   jobs:
  #     - job: WaitForApproval
  #       displayName: "Wait for Prod Approval"
  #       pool: 'server'
  #       steps:
  #         - task: ManualValidation@0
  #           inputs:
  #             instructions: 'Please approve the deployment to production.'
  #             onTimeout: 'reject'
  #             timeoutInMinutes: 180
  #             notifyUsers: |
  #               finn.tann@communities.gov.uk

  ############################## PROD Stage #########################################
  # - template: templates/prod.yml
  #   parameters:
  #     environment: 'production'
  
  ############################## RELEASE Stage ######################################
  - stage: release
    jobs:
      - job: TagAndRelease
        displayName: "Tag and Release"
        steps:
          - checkout: self
            persistCredentials: true

          - script: |
              TAG_NAME="prod-$(date +%Y%m%d%H%M%S)"
              echo "##[task.setvariable variable=releaseTag;isOutput=true]$TAG_NAME"
              git config --global user.email "you@example.com"
              git config --global user.name "Your Name"
              
              git tag -a $TAG_NAME -m "Release for production deployment"
              git push origin $TAG_NAME
            name: setTag  
            displayName: "setTag"
          
          - task: GitHubRelease@1
            displayName: "Create GitHub Release"
            inputs:
              gitHubConnection: '45647c5b-c060-4630-b3a5-44dfd890ba6d'
              repositoryName: 'communitiesuk/cdp_core'
              tagSource: 'userSpecifiedTag'
              tag: $(setTag.releaseTag)
              # target: 'refs/tags/prod-$(date +%Y%m%d%H%M%S)'
              releaseNotesSource: 'inline'
              releaseNotesInline: ${{ parameters.releaseNotes }}
              isDraft: false
              isPrerelease: false
              # assets: |
              #   $(Build.ArtifactStagingDirectory)/*.whl



# TODO - fix unit test run (explore whl / job)
# TODO - tagging release branch
# TODO - investigate email notifications
# TODO - investigate running only speciic jobs on PR