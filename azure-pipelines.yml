trigger:
  branches:
    include:
      - main


parameters:
  - name: environment
    displayName: 'Select Environment'
    type: string
    default: 'dev'
    values:
      - dev
      - test
      - prod


variables:
  - ${{ if eq(parameters.environment, 'dev') }}:
    - group: cdp-core-pipeline-dev-vars
  - ${{ if eq(parameters.environment, 'test') }}:
    - group: cdp-core-pipeline-test-vars
  - ${{ if eq(parameters.environment, 'prod') }}:
    - group: cdp-core-pipeline-prod-vars


stages:
  - template: templates/dev.yml
    parameters:
      environment: 'dev'


  # - template: templates/test.yml

  # - stage: ProdApproval
  #   dependsOn: TEST
  #   condition: succeeded('TEST')
  #   displayName: "Prod Approval"
  #   jobs:
  #     - job: WaitForApproval
  #       displayName: "Wait for Prod Approval"
  #       pool: 'server'
  #       steps:
  #         - task: ManualValidation@0
  #           inputs:
  #             instructions: 'Please approve the deployment to production.'
  #             onTimeout: 'reject'
  #             timeoutInMinutes: 180
  #             notifyUsers: |
  #               finn.tann@communities.gov.uk

  # - template: templates/prod.yml
  
  # - stage: release
  #   jobs:
  #     - job: CreateRelease
  #       steps:
  #         - script: |
  #             echo $(Build.SourceBranchName)
  #             echo $(Build.BuildId)
  #             git checkout $(Build.SourceBranchName)
  #             TAG_NAME=$(Build.BuildId)
  #             git push $(GITHUB_HOST) $TAG_NAME

  #             gh release create $TAG_NAME \
  #               --title "Release $TAG_NAME" \
  #               --notes "Release created by Azure DevOps pipeline." \
  #               --target $(Build.SourceBranchName) \
  #               --repo $(GITHUB_HOST)
  #           displayName: "Pipeline Completion"


# TODO - variable passthrough for databricks.yml
# TODO - fix unit test run (explore whl / job)
# TODO - tagging release branch
# TODO - add SIT tests
# TODO - investigate email notifications
# TODO - investigate running only speciic jobs on PR